<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Duende Survivor - Ecosistema $DUENDE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        :root {
            --primary: #39ff14; --gold: #ffd700; --danger: #ff0055; --blue: #0098EA;
            --bg-dark: #121418; --card: #1e2228; --nav: #0e1013;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background: radial-gradient(circle at top, #1a202c 0%, #000 100%);
            color: #fff; font-family: 'Rajdhani', sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* LOADER */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: opacity 0.8s ease; 
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HEADER */
        .header { 
            padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(14, 16, 19, 0.9); backdrop-filter: blur(15px); border-bottom: 2px solid var(--primary); z-index: 10; 
        }
        .token-balance-container {
            display: flex; align-items: center; background: rgba(255,255,255,0.05); 
            padding: 5px 15px; border-radius: 25px; border: 1px solid var(--gold);
        }
        .token-logo-small { width: 24px; height: 24px; margin-left: 8px; border-radius: 50%; }

        .screen { display: none; flex-grow: 1; flex-direction: column; align-items: center; width: 100%; overflow-y: auto; padding-bottom: 110px; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TIENDA */
        .shop-card {
            width: 90%; background: var(--card); border-radius: 15px; padding: 15px; margin: 10px 0;
            border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center;
        }
        .buy-btn { background: var(--primary); color: #000; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 900; cursor: pointer; }
        .buy-btn:disabled { background: #444; color: #888; }

        /* ARENA */
        #arena-container { width: 100%; height: 100%; position: relative; }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; background: #000; }
        .arena-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }

        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: var(--nav); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 0.8rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h2 style="color:var(--primary)">CARGANDO...</h2></div>

    <div class="header">
        <div id="ton-connect"></div>
        <div class="token-balance-container">
            <span id="scoreDisplay">0</span>
            <img src="static/coin.png" class="token-logo-small">
        </div>
    </div>

    <div id="tab-tap" class="screen active">
        <div style="margin-top:40px; text-align:center;">
            <img id="charImg" src="static/skin_duende_comunparatodos.png" style="width: 220px; filter: drop-shadow(0 0 15px var(--primary));">
            <h1 style="color:var(--primary); margin-top:20px;">MINER√çA ACTIVA</h1>
            <p>Toca para recolectar fragmentos de $DUENDE</p>
        </div>
    </div>

    <div id="tab-arena" class="screen">
        <div id="arena-container">
            <canvas id="gameCanvas"></canvas>
            <div id="arenaStart" class="arena-overlay">
                <h1 style="color:var(--danger)">ARENA SURVIVOR</h1>
                <button class="buy-btn" style="padding: 15px 30px;" onclick="startArena()">EMPEZAR (10‚ö°)</button>
            </div>
            <div id="arenaEnd" class="arena-overlay" style="display:none;">
                <h2>COMBATE TERMINADO</h2>
                <p style="font-size:1.5rem; color:var(--gold)">+ <span id="rewardNum">0</span> $DUENDE</p>
                <button class="buy-btn" onclick="closeArena()">ACEPTAR</button>
            </div>
        </div>
    </div>

    <div id="tab-shop" class="screen">
        <h2 style="color:var(--gold)">MEJORAS DE EQUIPAMIENTO</h2>
        <div class="shop-card">
            <div><strong>SUPER FUERZA</strong><br><small>+2 Da√±o en √°rea</small></div>
            <button class="buy-btn" onclick="buyItem('dmg', 500)">500 üí∞</button>
        </div>
        <div class="shop-card">
            <div><strong>BOTAS VELOCES</strong><br><small>+1.5 Velocidad de movimiento</small></div>
            <button class="buy-btn" onclick="buyItem('speed', 300)">300 üí∞</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="nav('tap', this)"><i class="fas fa-hammer"></i><span>MINAR</span></div>
        <div class="nav-item" onclick="nav('arena', this)"><i class="fas fa-skull-crossbones"></i><span>ARENA</span></div>
        <div class="nav-item" onclick="nav('shop', this)"><i class="fas fa-shopping-cart"></i><span>TIENDA</span></div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let state = { score: 1000, energy: 100, dmgBase: 1, speedBase: 6 };
        let gameActive = false, loopId, frame = 0, kills = 0;
        let player = { x: 0, y: 0, hp: 100 }, enemies = [], bullets = [], drops = [];
        let joystick = { active: false, sx: 0, sy: 0, nx: 0, ny: 0 };
        let invincible = false;

        const assets = {
            common: 'static/skin_duende_comunparatodos.png',
            bear: 'static/enemy_BEAR_MARKET.png',
            bullet: 'static/loot_COIN.png',
            bg: 'static/imagen_portada_home.png',
            coin: 'static/coin.png'
        };

        const imgs = {};
        let loaded = 0;
        Object.keys(assets).forEach(k => {
            imgs[k] = new Image();
            imgs[k].src = assets[k];
            imgs[k].onload = () => { if(++loaded === Object.keys(assets).length) document.getElementById('loader').style.display='none'; };
        });

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = Math.floor(state.score);
            document.querySelectorAll('.buy-btn').forEach(btn => {
                const cost = parseInt(btn.innerText);
                if(cost && state.score < cost) btn.disabled = true; else btn.disabled = false;
            });
        }

        function nav(t, b) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            b.classList.add('active');
            if(t !== 'arena') stopGame();
            updateUI();
        }

        function buyItem(type, price) {
            if(state.score >= price) {
                state.score -= price;
                if(type === 'dmg') state.dmgBase += 2;
                if(type === 'speed') state.speedBase += 1.5;
                tg.HapticFeedback.notificationOccurred('success');
                updateUI();
            }
        }

        // MOTOR DE JUEGO
        function startArena() {
            if(state.energy < 10) return tg.showAlert("Sin energ√≠a");
            state.energy -= 10;
            document.getElementById('arenaStart').style.display = 'none';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 150;
            player = { x: canvas.width/2, y: canvas.height/2, hp: 100 };
            enemies = []; bullets = []; kills = 0;
            gameActive = true;
            loop();
        }

        function stopGame() { gameActive = false; cancelAnimationFrame(loopId); }

        function loop() {
            if(!gameActive) return;
            frame++;
            ctx.clearRect(0,0,canvas.width, canvas.height);

            // Fondo simple
            ctx.fillStyle = "#111";
            ctx.fillRect(0,0,canvas.width, canvas.height);

            // Movimiento Joystick
            if(joystick.active) {
                const dx = joystick.nx - joystick.sx;
                const dy = joystick.ny - joystick.sy;
                const dist = Math.hypot(dx, dy);
                if(dist > 5) {
                    const ang = Math.atan2(dy, dx);
                    player.x += Math.cos(ang) * state.speedBase;
                    player.y += Math.sin(ang) * state.speedBase;
                }
            }

            // Spawn enemigos
            if(frame % 60 === 0) {
                enemies.push({ x: Math.random()*canvas.width, y: -50, hp: 2 });
            }

            // L√≥gica enemigos
            enemies.forEach((e, i) => {
                const ang = Math.atan2(player.y - e.y, player.x - e.x);
                e.x += Math.cos(ang) * 2;
                e.y += Math.sin(ang) * 2;
                ctx.drawImage(imgs.bear, e.x - 20, e.y - 20, 40, 40);

                if(Math.hypot(player.x - e.x, player.y - e.y) < 30) {
                    player.hp -= 0.5;
                    if(player.hp <= 0) endGame();
                }
            });

            // Disparo autom√°tico
            if(frame % 30 === 0 && enemies.length > 0) {
                bullets.push({x: player.x, y: player.y, vx: 0, vy: -10});
            }

            bullets.forEach((b, i) => {
                b.y += b.vy;
                ctx.drawImage(imgs.bullet, b.x - 10, b.y - 10, 20, 20);
                enemies.forEach((e, ei) => {
                    if(Math.hypot(b.x - e.x, b.y - e.y) < 30) {
                        e.hp -= state.dmgBase;
                        bullets.splice(i, 1);
                        if(e.hp <= 0) { enemies.splice(ei, 1); kills++; }
                    }
                });
            });

            // Dibujar Player
            ctx.drawImage(imgs.common, player.x - 30, player.y - 30, 60, 60);

            // UI Arena
            ctx.fillStyle = "white";
            ctx.fillText("KILLS: " + kills, 20, 30);
            ctx.fillStyle = "red";
            ctx.fillRect(20, 40, player.hp, 10);

            loopId = requestAnimationFrame(loop);
        }

        function endGame() {
            gameActive = false;
            const reward = kills * 10;
            state.score += reward;
            document.getElementById('rewardNum').innerText = reward;
            document.getElementById('arenaEnd').style.display = 'flex';
            updateUI();
        }

        function closeArena() {
            document.getElementById('arenaEnd').style.display = 'none';
            document.getElementById('arenaStart').style.display = 'flex';
        }

        // Controles T√°ctiles
        canvas.addEventListener('touchstart', e => {
            joystick.active = true;
            joystick.sx = e.touches[0].clientX;
            joystick.sy = e.touches[0].clientY;
            joystick.nx = e.touches[0].clientX;
            joystick.ny = e.touches[0].clientY;
        });
        canvas.addEventListener('touchmove', e => {
            joystick.nx = e.touches[0].clientX;
            joystick.ny = e.touches[0].clientY;
        });
        canvas.addEventListener('touchend', () => joystick.active = false);

        updateUI();
    </script>
</body>
</html>
