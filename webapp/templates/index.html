<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Duende App</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        :root {
            --neon-green: #39ff14;
            --neon-gold: #ffd700;
            --neon-red: #ff0055;
            --neon-blue: #00f3ff;
            --dark-bg: #050505;
            --card-bg: #161616;
        }

        body {
            margin: 0; padding: 0; background-color: var(--dark-bg); color: #ffffff;
            font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column;
            height: 100vh; user-select: none; overflow: hidden;
        }

        /* TOP BAR */
        .top-bar {
            flex-shrink: 0;
            width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;
            background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; z-index: 100;
        }
        .user-balance { font-size: 1.2rem; color: var(--neon-green); font-weight: 900; text-shadow: 0 0 10px rgba(57, 255, 20, 0.6); }

        /* SCREENS */
        .screen { display: none; flex-grow: 1; flex-direction: column; align-items: center; overflow-y: auto; padding-bottom: 90px; width: 100%; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease; }
        .screen-padded { padding: 20px; } /* Padding solo para pantallas que no son Arena */
        
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .loader-spinner {
            border: 4px solid #222; border-top: 4px solid var(--neon-green);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TAP TO EARN --- */
        .main-button {
            width: 260px; height: 260px;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            border-radius: 50%; border: 5px solid var(--neon-green);
            box-shadow: 0 0 60px rgba(57, 255, 20, 0.2);
            display: flex; justify-content: center; align-items: center;
            margin: 40px 0; cursor: pointer; position: relative; 
            transition: all 0.1s ease; /* Para la animaci√≥n de golpe */
        }
        /* Efecto de Golpe */
        .main-button:active { transform: scale(0.9) rotate(5deg); border-color: #fff; }
        
        .floating-text { position: absolute; color: var(--neon-gold); font-weight: 900; pointer-events: none; animation: float 0.6s forwards; font-size: 2.5rem; z-index: 200; text-shadow: 2px 2px 0 #000; }
        @keyframes float { to { transform: translateY(-150px) scale(1.5); opacity: 0; } }

        /* --- ARENA (SURVIVOR MODE) --- */
        #screen-arena { padding: 0; overflow: hidden; position: relative; } /* Fullscreen */
        
        .arena-container {
            width: 100%; height: 100%; background: #000; position: relative;
        }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; touch-action: none; }
        
        .arena-hud {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
            border: 1px solid var(--neon-green); color: var(--neon-green); font-weight: 900; font-size: 1.2rem;
        }

        .arena-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20; backdrop-filter: blur(8px);
        }
        .btn-start {
            background: linear-gradient(180deg, var(--neon-red), #500);
            color: #fff; border: 2px solid #ff5555; padding: 15px 60px; font-size: 1.5rem;
            font-weight: 900; border-radius: 10px; cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.4);
            text-transform: uppercase; letter-spacing: 2px;
            animation: pulseBtn 2s infinite;
        }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- RANKING --- */
        .rank-list { width: 100%; max-width: 400px; margin-top: 10px; }
        .rank-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px; margin-bottom: 8px; border-radius: 10px;
            border: 1px solid #333;
        }
        .rank-pos { font-size: 1.2rem; font-weight: 900; color: #888; width: 30px; }
        .rank-1 { color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold); }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        .rank-user { border: 1px solid var(--neon-green); background: rgba(57, 255, 20, 0.1); }

        /* --- TIENDA & NAV --- */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px; }
        .shop-card { background: var(--card-bg); border: 1px solid #333; border-radius: 10px; padding: 10px; text-align: center; }
        .shop-img { width: 60px; height: 60px; object-fit: contain; }
        .buy-btn { width: 100%; padding: 8px; border-radius: 5px; border:none; font-weight:bold; cursor:pointer; margin-top:5px;}
        .btn-ton { background: #0098EA; color: white; }
        .btn-pts { background: var(--neon-gold); color: black; }

        .bottom-nav {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 420px; height: 70px;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; border: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center; z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .nav-item { color: #666; font-size: 0.7rem; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--neon-green); transform: translateY(-2px); }
    </style>
</head>
<body>

    <div id="loader"><div class="loader-spinner"></div><p style="margin-top:20px; color:#888;">INICIANDO SISTEMA...</p></div>

    <div class="top-bar">
        <div id="ton-connect"></div>
        <div class="user-balance">$ <span id="displayScore">0</span></div>
    </div>

    <div id="screen-tap" class="screen screen-padded active">
        <h2 style="color: #888; letter-spacing: 4px; font-size: 0.9rem;">MINADO ACTIVO</h2>
        
        <div class="main-button" id="clickBtn">
            <img id="mainTapImage" src="" style="width: 80%; height: 80%; object-fit: contain; pointer-events: none; filter: drop-shadow(0 0 15px var(--neon-green));">
        </div>
        
        <div style="width: 100%; max-width: 350px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#ccc; font-weight:bold;">
                <span>‚ö° ENERG√çA</span><span><span id="energyVal">500</span>/<span id="maxEnergyVal">500</span></span>
            </div>
            <div style="background:#222; height:18px; border-radius:10px; overflow:hidden; border:1px solid #444;">
                <div style="height:100%; background:linear-gradient(90deg, #ffd700, #ff0055); width:100%; transition:width 0.2s;" id="energyBar"></div>
            </div>
        </div>
    </div>

    <div id="screen-arena" class="screen">
        <div class="arena-container">
            <div class="arena-hud">KILLS: <span id="killCount">0</span></div>
            <canvas id="gameCanvas"></canvas>
            
            <div id="arenaOverlay" class="arena-overlay">
                <h1 style="color:var(--neon-red); font-size:3rem; margin:0; text-shadow:0 0 20px red;">SURVIVOR</h1>
                <p style="color:#ccc; margin-bottom:30px;">Resiste la oleada bajista</p>
                <button class="btn-start" onclick="startArena()">BATALLA (50‚ö°)</button>
                <div id="arenaReward" style="margin-top:20px; color:var(--neon-green); font-size:1.5rem; font-weight:bold; display:none;"></div>
            </div>
        </div>
    </div>

    <div id="screen-rank" class="screen screen-padded">
        <h2 style="color:var(--neon-blue); letter-spacing:2px;">TOP TRADERS</h2>
        <div class="rank-list">
            <div class="rank-item">
                <div class="rank-pos rank-1">1</div>
                <div style="flex-grow:1; margin-left:10px;">CryptoWhale</div>
                <div style="color:var(--neon-gold); font-weight:bold;">9,450,200</div>
            </div>
            <div class="rank-item">
                <div class="rank-pos rank-2">2</div>
                <div style="flex-grow:1; margin-left:10px;">ElonDoge</div>
                <div style="color:#fff; font-weight:bold;">8,200,100</div>
            </div>
            <div class="rank-item">
                <div class="rank-pos rank-3">3</div>
                <div style="flex-grow:1; margin-left:10px;">Satoshi_Peru</div>
                <div style="color:#fff; font-weight:bold;">7,500,000</div>
            </div>
            
            <div style="text-align:center; color:#444; margin: 10px;">...</div>

            <div class="rank-item rank-user">
                <div class="rank-pos" style="color:var(--neon-green);">99+</div>
                <div style="flex-grow:1; margin-left:10px;">T√ö (El Duende)</div>
                <div style="color:var(--neon-green); font-weight:bold;" id="rankScoreDisplay">0</div>
            </div>
        </div>
    </div>

    <div id="screen-shop" class="screen screen-padded">
        <h2 style="color: var(--neon-gold);">MERCADO NEGRO</h2>
        <div class="shop-grid">
            <div class="shop-card">
                <img src="/static/skin_DUENDE_HACKER.png" class="shop-img">
                <div style="font-weight:bold;">HACKER</div>
                <div style="font-size:0.7rem; color:#888;">Velocidad x2</div>
                <button class="buy-btn btn-ton" onclick="payWithTon('hacker', 0.2)">0.2 TON</button>
            </div>
            <div class="shop-card">
                <img src="/static/skin_DUENDE_BOX.png" class="shop-img">
                <div style="font-weight:bold;">BOXER</div>
                <div style="font-size:0.7rem; color:#888;">Da√±o Cr√≠tico</div>
                <button class="buy-btn btn-ton" onclick="payWithTon('boxer', 0.5)">0.5 TON</button>
            </div>
            <div class="shop-card">
                <img src="/static/booster_RAYOTON.png" class="shop-img">
                <div style="font-weight:bold;">RECARGA</div>
                <div style="font-size:0.7rem; color:#888;">Energ√≠a Full</div>
                <button class="buy-btn btn-pts" onclick="buyBooster('refill', 500)">500 Pts</button>
            </div>
            <div class="shop-card">
                <img src="/static/booster_INVENCIBLE_90S.png" class="shop-img">
                <div style="font-weight:bold;">ESCUDO</div>
                <div style="font-size:0.7rem; color:#888;">Invencible</div>
                <button class="buy-btn btn-pts" onclick="buyBooster('shield', 2000)">2k Pts</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('tap', this)"><span class="nav-icon">‚õèÔ∏è</span>Minar</div>
        <div class="nav-item" onclick="switchTab('arena', this)"><span class="nav-icon">‚öîÔ∏è</span>Arena</div>
        <div class="nav-item" onclick="switchTab('rank', this)"><span class="nav-icon">üèÜ</span>Ranking</div>
        <div class="nav-item" onclick="switchTab('shop', this)"><span class="nav-icon">üõí</span>Tienda</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#000000');

        const MY_WALLET = "UQAm2w4HcJ1tW8RBNj7BZQh0Q-ckpzlxzD-r8p2JduHkpQnc";

        // --- CARGA DE ASSETS ---
        // AHORA LA SKIN POR DEFECTO ES LA COM√öN
        const assets = {
            common: '/static/skin_duende_comunparatodos.png', // NUEVA
            hacker: '/static/skin_DUENDE_HACKER.png',
            boxer: '/static/skin_DUENDE_BOX.png',
            king: '/static/skin_REY_DUENDE.png',
            bear: '/static/enemy_BEAR_MARKET.png',
            rug: '/static/enemy_RUG_PULL.png',
            whale: '/static/enemy_WHALE.png',
            bullet: '/static/loot_COIN.png'
        };

        const images = {};
        let assetsLoaded = 0;
        const totalAssets = Object.keys(assets).length;

        function loadAssets() {
            for (let key in assets) {
                images[key] = new Image();
                images[key].src = assets[key];
                images[key].onload = () => { assetsLoaded++; if(assetsLoaded===totalAssets) startGame(); };
            }
        }

        function startGame() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('screen-tap').classList.add('active');
            // Cargar imagen por defecto (Com√∫n)
            document.getElementById('mainTapImage').src = images.common.src;
            updateUI();
        }

        let state = { score: 0, energy: 500, maxEnergy: 500, currentSkin: 'common', tapPower: 1, arenaMulti: 1 };
        let invincible = false;

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: window.location.origin + '/static/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        // --- PAGOS ---
        async function payWithTon(skinName, price) {
            if (!tonConnectUI.connected) return alert("Conecta Wallet");
            const nano = Math.floor(price * 1000000000).toString();
            try {
                await tonConnectUI.sendTransaction({
                    validUntil: Math.floor(Date.now()/1000)+3600,
                    messages: [{ address: MY_WALLET, amount: nano }]
                });
                alert("Pago Recibido");
                activateSkin(skinName);
            } catch(e) { alert("Error Pago"); }
        }

        function buyBooster(type, cost) {
            if(state.score >= cost) {
                state.score -= cost;
                if(type === 'refill') state.energy = state.maxEnergy;
                if(type === 'shield') { invincible = true; setTimeout(()=>invincible=false, 90000); alert("Escudo 90s"); }
                updateUI();
            } else alert("Faltan puntos");
        }

        function activateSkin(name) {
            state.currentSkin = name;
            let img = document.getElementById('mainTapImage');
            if(name === 'hacker') { img.src = images.hacker.src; state.tapPower = 2; }
            else if(name === 'boxer') { img.src = images.boxer.src; state.tapPower = 3; }
            else if(name === 'king') { img.src = images.king.src; state.arenaMulti = 2; }
            else { img.src = images.common.src; state.tapPower = 1; } // Default Com√∫n
        }

        // --- TAP ---
        document.getElementById('clickBtn').addEventListener('click', (e) => {
            if (state.energy >= 1) {
                state.score += state.tapPower; state.energy -= 1; updateUI();
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('heavy'); // Vibraci√≥n fuerte
                
                let el = document.createElement('div'); el.className = 'floating-text'; el.innerText = '+' + state.tapPower;
                let x = e.clientX || window.innerWidth/2; let y = e.clientY || window.innerHeight/2;
                el.style.left = x + 'px'; el.style.top = y + 'px';
                document.body.appendChild(el); setTimeout(() => el.remove(), 600);
            }
        });
        setInterval(() => { if(state.energy < state.maxEnergy) { state.energy++; updateUI(); } }, 1000);

        function updateUI() {
            document.getElementById('displayScore').innerText = Math.floor(state.score).toLocaleString();
            document.getElementById('rankScoreDisplay').innerText = Math.floor(state.score).toLocaleString();
            document.getElementById('energyVal').innerText = state.energy;
            document.getElementById('energyBar').style.width = (state.energy/state.maxEnergy*100) + '%';
        }

        window.switchTab = function(name, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('screen-'+name).classList.add('active');
            el.classList.add('active');
            if(name !== 'arena') stopArena();
        }

        // --- SURVIVOR IO ENGINE (MEJORADO) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameLoopId, arenaActive = false;
        let player = { x: 0, y: 0, speed: 5 };
        let enemies = [], bullets = [], particles = [];
        let kills = 0; let frame = 0;
        let touchX = null, touchY = null;
        let camX = 0, camY = 0;

        function resizeCanvas() { 
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr); canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
        }

        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); let rect = canvas.getBoundingClientRect(); touchX = e.touches[0].clientX - rect.left; touchY = e.touches[0].clientY - rect.top; }, {passive:false});
        canvas.addEventListener('touchend', () => { touchX = null; touchY = null; });

        window.startArena = function() {
            if (state.energy < 50) { alert("Necesitas 50 de Energ√≠a"); return; }
            state.energy -= 50; updateUI();
            document.getElementById('arenaOverlay').style.display = 'none';
            resizeCanvas();
            player.x = 0; player.y = 0;
            enemies = []; bullets = []; particles = []; kills = 0; arenaActive = true; loop();
        }

        function stopArena() { arenaActive = false; cancelAnimationFrame(gameLoopId); }
        function gameOver() {
            stopArena();
            state.score += kills * 10 * state.arenaMulti; updateUI();
            document.getElementById('arenaReward').innerText = "Ganaste: " + (kills * 10) + " $ELDUENDE";
            document.getElementById('arenaReward').style.display = 'block';
            document.getElementById('arenaOverlay').style.display = 'flex';
        }

        function spawnParticles(x, y, color) {
            for(let i=0; i<5; i++) particles.push({x:x, y:y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1, color:color});
        }

        function loop() {
            if (!arenaActive) return;
            const W = canvas.width / (window.devicePixelRatio||1);
            const H = canvas.height / (window.devicePixelRatio||1);
            camX = player.x - W/2; camY = player.y - H/2;

            // Background
            ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,W,H);
            // Grid
            ctx.strokeStyle = 'rgba(57, 255, 20, 0.1)'; ctx.lineWidth=2;
            const gridSize = 80;
            const startX = Math.floor(camX/gridSize)*gridSize;
            const startY = Math.floor(camY/gridSize)*gridSize;
            for(let i=startX; i<camX+W+gridSize; i+=gridSize) {
                for(let j=startY; j<camY+H+gridSize; j+=gridSize) {
                    ctx.strokeRect(i-camX, j-camY, gridSize, gridSize);
                }
            }

            // Player Move
            if(touchX !== null) {
                let dx = touchX - W/2; let dy = touchY - H/2;
                let dist = Math.hypot(dx, dy);
                if(dist > 10) { player.x += (dx/dist)*player.speed; player.y += (dy/dist)*player.speed; }
            }

            // Draw Player (Com√∫n por defecto)
            let sprite = images.common;
            if(state.currentSkin === 'hacker') sprite = images.hacker;
            if(state.currentSkin === 'boxer') sprite = images.boxer;
            if(state.currentSkin === 'king') sprite = images.king;
            
            let pX = W/2; let pY = H/2;
            if(invincible) { ctx.beginPath(); ctx.arc(pX, pY, 40, 0, Math.PI*2); ctx.strokeStyle='#00ffff'; ctx.stroke(); }
            ctx.drawImage(sprite, pX-30, pY-30, 60, 60);

            // Enemies (Con HP)
            if(frame % 50 === 0) {
                let r = Math.random(); let eImg = images.bear; let speed = 2; let hp = 3; // OSO = 3 HITS
                if(r > 0.8) { eImg = images.rug; speed = 3.5; hp = 2; } // RUG = 2 HITS
                if(r > 0.98) { eImg = images.whale; speed = 1; hp = 15; } // BALLENA = 15 HITS
                
                let angle = Math.random() * Math.PI * 2;
                let dist = W + 100;
                enemies.push({ x: player.x+Math.cos(angle)*dist, y: player.y+Math.sin(angle)*dist, img: eImg, speed: speed, hp: hp, maxHp: hp });
            }

            // Auto Fire
            if(frame % 20 === 0 && enemies.length > 0) {
                let nearest = enemies[0]; // Simplificado
                let dx = nearest.x - player.x; let dy = nearest.y - player.y;
                let dist = Math.hypot(dx, dy);
                bullets.push({x: player.x, y: player.y, vx: (dx/dist)*10, vy: (dy/dist)*10});
            }

            // Logic Update
            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i]; b.x += b.vx; b.y += b.vy;
                ctx.drawImage(images.bullet, b.x-camX-10, b.y-camY-10, 20, 20);
                if(Math.hypot(b.x-player.x, b.y-player.y) > 1000) bullets.splice(i, 1);
            }

            for(let i=enemies.length-1; i>=0; i--) {
                let e = enemies[i];
                let dx = player.x - e.x; let dy = player.y - e.y; let dist = Math.hypot(dx, dy);
                e.x += (dx/dist)*e.speed; e.y += (dy/dist)*e.speed;
                
                // Draw Enemy
                ctx.drawImage(e.img, e.x-camX-25, e.y-camY-25, 50, 50);
                
                // HP Bar (Solo si est√° herido)
                if(e.hp < e.maxHp) {
                    ctx.fillStyle = 'red'; ctx.fillRect(e.x-camX-20, e.y-camY-35, 40, 5);
                    ctx.fillStyle = '#0f0'; ctx.fillRect(e.x-camX-20, e.y-camY-35, 40 * (e.hp/e.maxHp), 5);
                }

                if(dist < 30 && !invincible) { gameOver(); return; }

                // Collisions
                for(let j=bullets.length-1; j>=0; j--) {
                    let b = bullets[j];
                    if(Math.hypot(e.x-b.x, e.y-b.y) < 35) {
                        bullets.splice(j,1);
                        e.hp--; // BAJAR VIDA
                        spawnParticles(e.x, e.y, '#fff'); // Efecto golpe
                        if(e.hp <= 0) {
                            spawnParticles(e.x, e.y, '#ff0000'); // Explosi√≥n muerte
                            enemies.splice(i,1); kills++;
                            document.getElementById('killCount').innerText = kills;
                        }
                        break;
                    }
                }
            }

            // Particles
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.1;
                if(p.life <= 0) particles.splice(i,1);
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.fillRect(p.x-camX, p.y-camY, 4, 4);
            }
            ctx.globalAlpha = 1.0;

            frame++; gameLoopId = requestAnimationFrame(loop);
        }

        loadAssets();
    </script>
</body>
</html>
