<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Duende App</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        :root {
            --primary: #39ff14; --gold: #ffd700; --danger: #ff0055; --blue: #0098EA;
            --bg-dark: #050505; --card-bg: #141414;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: radial-gradient(circle at center, #111 0%, #000 100%); color: #fff; font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; }

        /* UI ELEMENTS */
        .glass-panel { background: rgba(20,20,20,0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; }
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; z-index: 100; }
        .user-balance { font-size: 1.2rem; color: var(--primary); font-weight: 900; text-shadow: 0 0 10px rgba(57,255,20,0.4); }
        .screen { display: none; flex-grow: 1; flex-direction: column; align-items: center; width: 100%; overflow-y: auto; padding-bottom: 100px; }
        .screen.active { display: flex; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        /* TAP ZONE */
        .tap-container { position: relative; margin-top: 40px; }
        .main-character { width: 260px; height: 260px; object-fit: contain; filter: drop-shadow(0 0 20px rgba(57,255,20,0.5)); transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .main-character:active { transform: scale(0.9) rotate(2deg); } /* GOLPE MANUAL */
        
        .energy-bar-container { width: 80%; max-width: 300px; height: 12px; background: #222; border-radius: 6px; overflow: hidden; margin-top: 20px; border: 1px solid #444; }
        .energy-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--danger)); width: 100%; transition: width 0.2s; }

        /* ARENA */
        .arena-wrapper { width: 100%; height: 100%; position: relative; background: #000; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        .arena-ui { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; font-weight: 900; color: #fff; text-shadow: 2px 2px 0 #000; pointer-events: none; }
        .vignette { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, transparent 60%, black 100%); pointer-events: none; }
        
        .overlay-menu { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
        .play-btn { background: linear-gradient(135deg, var(--danger), #900); color: white; border: none; padding: 15px 50px; font-size: 1.5rem; border-radius: 12px; font-weight: 900; letter-spacing: 2px; box-shadow: 0 0 20px var(--danger); cursor: pointer; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* SHOP & NAV */
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%; max-width: 400px; margin-top: 20px; }
        .shop-item { padding: 15px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .shop-item img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; }
        .buy-btn { width: 100%; padding: 8px; border-radius: 6px; border:none; font-weight:bold; margin-top:5px; cursor: pointer; }
        .btn-ton { background: var(--blue); color: white; } .btn-pts { background: var(--gold); color: black; }

        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 400px; height: 70px; display: flex; justify-content: space-around; align-items: center; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 0.7rem; transition: 0.2s; }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-btn.active { color: var(--primary); transform: translateY(-3px); text-shadow: 0 0 10px var(--primary); }

        /* FX */
        .dmg-text { position: absolute; font-weight: 900; font-size: 1.2rem; pointer-events: none; animation: floatDmg 0.5s forwards; text-shadow: 1px 1px 0 #000; }
        @keyframes floatDmg { 0% { opacity:1; transform: translateY(0) scale(1); } 100% { opacity:0; transform: translateY(-50px) scale(1.5); } }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="width:50px; height:50px; border:4px solid #333; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; color:#666; letter-spacing:2px; font-weight:bold;">CARGANDO...</p>
    </div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <div class="top-bar">
        <div id="ton-connect"></div>
        <div><span style="color:#888; font-size:0.8rem;">BALANCE</span> <br> <span class="user-balance" id="scoreDisplay">0</span> <span style="color:var(--gold);">$D</span></div>
    </div>

    <div id="tab-tap" class="screen active">
        <h2 style="color:#888; letter-spacing:3px; font-size:1rem; margin-top:20px;">MINADO CENTRAL</h2>
        <div class="tap-container" id="tapArea">
            <img id="charImg" src="" class="main-character">
        </div>
        <div style="margin-top:30px; text-align:center; width:100%;">
            <div style="display:flex; justify-content:space-between; width:80%; margin:0 auto; font-size:0.9rem; font-weight:bold; color:#ccc;">
                <span>‚ö° ENERG√çA</span> <span id="energyTxt">500/500</span>
            </div>
            <div class="energy-bar-container"><div class="energy-fill" id="energyFill"></div></div>
        </div>
        
        <div style="margin-top:30px; display:flex; gap:15px;">
            <a href="https://t.me/elduende420peru" target="_blank" style="color:#fff; font-size:1.8rem;"><i class="fab fa-telegram"></i></a>
            <a href="https://wa.me/51900877863" target="_blank" style="color:#fff; font-size:1.8rem;"><i class="fab fa-whatsapp"></i></a>
            <a href="https://www.facebook.com/profile.php?id=61586213196155" target="_blank" style="color:#fff; font-size:1.8rem;"><i class="fab fa-facebook"></i></a>
        </div>
    </div>

    <div id="tab-arena" class="screen" style="padding:0;">
        <div class="arena-wrapper">
            <canvas id="gameCanvas"></canvas>
            <div class="vignette"></div>
            <div class="arena-ui">
                <div style="color:var(--danger);">üíÄ <span id="killsTxt">0</span></div>
                <div style="font-size:1rem; color:var(--primary);">HP: <span id="hpTxt">100</span>%</div>
            </div>

            <div id="arenaMenu" class="overlay-menu">
                <h1 style="font-size:3rem; color:var(--danger); text-shadow:0 0 30px var(--danger); margin:0;">SURVIVOR</h1>
                <p style="color:#ccc; margin-bottom:30px;">Sobrevive a la ca√≠da del mercado</p>
                <button class="play-btn" onclick="startArena()">JUGAR<br><span style="font-size:0.8rem;">(50‚ö° o 150 $D)</span></button>
            </div>

            <div id="arenaOver" class="overlay-menu" style="display:none;">
                <h1 style="color:var(--primary); font-size:2.5rem;">¬°MISI√ìN CUMPLIDA!</h1>
                <p id="rewardTxt" style="font-size:1.5rem; font-weight:bold; color:#fff;">+0 $D</p>
                <button class="play-btn" style="background:#333; box-shadow:none; font-size:1rem; padding:15px 30px; margin-top:20px;" onclick="closeArena()">VOLVER A LA BASE</button>
            </div>
        </div>
    </div>

    <div id="tab-shop" class="screen">
        <h2 style="color:var(--gold); margin-top:20px;">MERCADO NEGRO</h2>
        
        <div class="shop-grid">
            <div class="shop-item glass-panel">
                <img src="/static/skin_DUENDE_HACKER.png">
                <div style="font-weight:bold;">HACKER</div>
                <div style="font-size:0.7rem; color:#888;">Velocidad x2</div>
                <button class="buy-btn btn-ton" onclick="payTon('hacker', 0.2)">0.2 TON</button>
            </div>
            <div class="shop-item glass-panel">
                <img src="/static/skin_DUENDE_BOX.png">
                <div style="font-weight:bold;">BOXER</div>
                <div style="font-size:0.7rem; color:#888;">Da√±o Cr√≠tico</div>
                <button class="buy-btn btn-ton" onclick="payTon('boxer', 0.5)">0.5 TON</button>
            </div>
            <div class="shop-item glass-panel">
                <img src="/static/booster_RAYOTON.png">
                <div style="font-weight:bold;">RECARGA</div>
                <button class="buy-btn btn-pts" onclick="buyItem('refill', 500)">500 $D</button>
            </div>
            <div class="shop-item glass-panel">
                <img src="/static/booster_INVENCIBLE_90S.png">
                <div style="font-weight:bold;">ESCUDO</div>
                <button class="buy-btn btn-pts" onclick="buyItem('shield', 2000)">2k $D</button>
            </div>
        </div>
    </div>

    <div class="nav-bar glass-panel">
        <div class="nav-btn active" onclick="nav('tap', this)"><i class="fas fa-hammer"></i><span>Minar</span></div>
        <div class="nav-btn" onclick="nav('arena', this)"><i class="fas fa-skull"></i><span>Arena</span></div>
        <div class="nav-btn" onclick="nav('shop', this)"><i class="fas fa-shopping-cart"></i><span>Tienda</span></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand(); tg.setHeaderColor('#000000');
        const MY_WALLET = "UQAm2w4HcJ1tW8RBNj7BZQh0Q-ckpzlxzD-r8p2JduHkpQnc";

        // ASSETS
        const assets = {
            common: '/static/skin_duende_comunparatodos.png',
            hacker: '/static/skin_DUENDE_HACKER.png',
            boxer: '/static/skin_DUENDE_BOX.png',
            king: '/static/skin_REY_DUENDE.png',
            bear: '/static/enemy_BEAR_MARKET.png',
            rug: '/static/enemy_RUG_PULL.png',
            whale: '/static/enemy_WHALE.png',
            bullet: '/static/loot_COIN.png'
        };
        const imgs = {}; let assetsLoaded = 0;
        Object.keys(assets).forEach(k => {
            imgs[k] = new Image(); imgs[k].src = assets[k];
            imgs[k].onload = () => { assetsLoaded++; if(assetsLoaded===Object.keys(assets).length) init(); };
        });

        // STATE
        let state = { score: 0, energy: 500, maxEnergy: 500, skin: 'common', power: 1 };
        let invincible = false;

        function init() {
            document.getElementById('loader').style.display='none';
            document.getElementById('charImg').src = imgs.common.src;
            updateUI();
        }

        // UI & LOGIC
        const tonUi = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: window.location.origin + '/static/tonconnect-manifest.json', buttonRootId: 'ton-connect', uiPreferences: {theme: TON_CONNECT_UI.THEME.DARK} });

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = Math.floor(state.score).toLocaleString();
            document.getElementById('energyTxt').innerText = `${Math.floor(state.energy)}/${state.maxEnergy}`;
            document.getElementById('energyFill').style.width = (state.energy/state.maxEnergy*100) + '%';
        }

        function nav(tab, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(tab !== 'arena') stopArena();
        }

        // TAP MECHANIC
        document.getElementById('tapArea').addEventListener('click', (e) => {
            if(state.energy < 1) return;
            state.energy--; state.score += state.power; updateUI();
            
            // Animaci√≥n de Golpe (Procedural)
            const char = document.getElementById('charImg');
            char.style.transform = "scale(0.95) rotate(3deg)";
            setTimeout(() => char.style.transform = "scale(1) rotate(0deg)", 100);

            // Floating Text
            const float = document.createElement('div');
            float.innerText = "+" + state.power;
            float.style.position = 'absolute';
            float.style.left = e.clientX + 'px';
            float.style.top = e.clientY + 'px';
            float.style.color = 'var(--gold)';
            float.style.fontWeight = '900';
            float.style.fontSize = '2rem';
            float.style.pointerEvents = 'none';
            float.style.animation = 'floatDmg 0.8s forwards';
            document.body.appendChild(float);
            setTimeout(()=>float.remove(), 800);

            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        });
        setInterval(() => { if(state.energy < state.maxEnergy) { state.energy++; updateUI(); } }, 1000);

        // SHOP
        async function payTon(skin, cost) {
            if(!tonUi.connected) return alert("Conecta Wallet");
            try {
                await tonUi.sendTransaction({validUntil: Math.floor(Date.now()/1000)+3600, messages:[{address:MY_WALLET, amount:Math.floor(cost*1000000000).toString()}]});
                alert("¬°Comprado!");
                state.skin = skin; updateChar();
            } catch(e) { alert("Error"); }
        }
        function buyItem(type, cost) {
            if(state.score < cost) return alert("Faltan $D");
            state.score -= cost;
            if(type==='refill') state.energy = state.maxEnergy;
            if(type==='shield') { invincible=true; setTimeout(()=>invincible=false, 90000); alert("Escudo 90s"); }
            updateUI();
        }
        function updateChar() {
            let src = imgs.common.src; state.power=1;
            if(state.skin==='hacker') { src=imgs.hacker.src; state.power=2; }
            if(state.skin==='boxer') { src=imgs.boxer.src; state.power=3; }
            document.getElementById('charImg').src = src;
        }

        // --- ARENA ENGINE PRO (Procedural Animation) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameActive = false, loopId;
        let player = {x:0, y:0, hp:100}, enemies=[], bullets=[], particles=[];
        let kills=0;
        let stick = {active:false, sx:0, sy:0, nx:0, ny:0};
        let frame=0;

        function startArena() {
            if(state.energy < 50 && state.score < 150) return alert("Falta Energ√≠a o $D");
            if(state.energy >= 50) state.energy-=50; else state.score-=150;
            updateUI();
            
            document.getElementById('arenaMenu').style.display='none';
            document.getElementById('arenaOver').style.display='none';
            resize();
            player = {x:0, y:0, hp:100, maxHp:100}; enemies=[]; bullets=[]; particles=[]; kills=0;
            gameActive = true; loop();
        }
        
        function stopArena() { gameActive = false; cancelAnimationFrame(loopId); }
        function closeArena() { document.getElementById('arenaMenu').style.display='flex'; document.getElementById('arenaOver').style.display='none'; }
        
        function resize() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.parentElement.clientWidth * dpr;
            canvas.height = canvas.parentElement.clientHeight * dpr;
            ctx.scale(dpr, dpr);
        }

        // Joystick
        canvas.addEventListener('touchstart', e=>{ stick.active=true; stick.sx=e.touches[0].clientX; stick.sy=e.touches[0].clientY; stick.nx=stick.sx; stick.ny=stick.sy; });
        canvas.addEventListener('touchmove', e=>{ if(stick.active) { e.preventDefault(); stick.nx=e.touches[0].clientX; stick.ny=e.touches[0].clientY; } });
        canvas.addEventListener('touchend', ()=>{ stick.active=false; });

        function loop() {
            if(!gameActive) return;
            const W = canvas.width / window.devicePixelRatio;
            const H = canvas.height / window.devicePixelRatio;
            
            // Movement
            let moveX=0, moveY=0;
            if(stick.active) {
                const dx = stick.nx - stick.sx; const dy = stick.ny - stick.sy;
                const angle = Math.atan2(dy, dx);
                const dist = Math.min(Math.hypot(dx, dy), 50);
                if(dist > 10) {
                    moveX = Math.cos(angle) * 4;
                    moveY = Math.sin(angle) * 4;
                    player.x += moveX; player.y += moveY;
                }
            }

            // Camera
            const camX = player.x - W/2; const camY = player.y - H/2;

            // Render BG
            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,W,H);
            ctx.strokeStyle = '#111'; ctx.lineWidth = 3;
            const grid=80;
            const ox = Math.floor(camX/grid)*grid; const oy = Math.floor(camY/grid)*grid;
            for(let i=ox; i<camX+W+grid; i+=grid) for(let j=oy; j<camY+H+grid; j+=grid) ctx.strokeRect(i-camX, j-camY, grid, grid);

            // ANIMACI√ìN PROCEDURAL JUGADOR (Wobble al caminar)
            let wobble = 0;
            if(stick.active) wobble = Math.sin(Date.now()/100) * 0.1; // Rotaci√≥n al andar
            
            // Draw Player
            const pScreenX = W/2; const pScreenY = H/2;
            let pSprite = imgs.common;
            if(state.skin === 'hacker') pSprite = imgs.hacker;
            if(state.skin === 'boxer') pSprite = imgs.boxer;

            ctx.save();
            ctx.translate(pScreenX, pScreenY);
            ctx.rotate(wobble); // Aplicar rotaci√≥n
            if(invincible) { ctx.beginPath(); ctx.arc(0,0,40,0,6.28); ctx.strokeStyle='#0ff'; ctx.stroke(); }
            
            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(0, 25, 20, 8, 0, 0, 6.28); ctx.fill();
            
            ctx.drawImage(pSprite, -30, -30, 60, 60);
            ctx.restore();

            // Spawn Enemies
            if(frame%60===0) {
                const angle = Math.random()*6.28;
                const dist = W/2 + 100;
                let type='bear', hp=3, spd=2;
                if(Math.random()>0.8) { type='rug'; spd=3.5; hp=2; }
                enemies.push({x:player.x+Math.cos(angle)*dist, y:player.y+Math.sin(angle)*dist, type:type, hp:hp, maxHp:hp, spd:spd, flash:0});
            }

            // Auto Shoot (Recoil Effect)
            if(frame%20===0 && enemies.length>0) {
                const target = enemies.reduce((a,b)=>Math.hypot(a.x-player.x, a.y-player.y)<Math.hypot(b.x-player.x, b.y-player.y)?a:b);
                const angle = Math.atan2(target.y-player.y, target.x-player.x);
                bullets.push({x:player.x, y:player.y, vx:Math.cos(angle)*10, vy:Math.sin(angle)*10, life:100});
                
                // Recoil: Mover al jugador un poco atr√°s
                player.x -= Math.cos(angle)*2;
                player.y -= Math.sin(angle)*2;
            }

            // Logic Loop
            bullets.forEach((b,i) => {
                b.x += b.vx; b.y += b.vy; b.life--;
                ctx.drawImage(imgs.bullet, b.x-camX-10, b.y-camY-10, 20, 20);
                if(b.life<=0) bullets.splice(i,1);
            });

            enemies.forEach((e,i) => {
                const angle = Math.atan2(player.y-e.y, player.x-e.x);
                e.x += Math.cos(angle)*e.spd; e.y += Math.sin(angle)*e.spd;
                
                const ex = e.x-camX; const ey = e.y-camY;
                
                // Animaci√≥n da√±o
                if(e.flash > 0) { ctx.globalAlpha = 0.5; e.flash--; }
                ctx.drawImage(imgs[e.type], ex-25, ey-25, 50, 50);
                ctx.globalAlpha = 1.0;

                // Barra vida
                if(e.hp < e.maxHp) {
                    ctx.fillStyle='red'; ctx.fillRect(ex-20, ey-35, 40, 4);
                    ctx.fillStyle='#0f0'; ctx.fillRect(ex-20, ey-35, 40*(e.hp/e.maxHp), 4);
                }

                // Colisiones
                if(Math.hypot(player.x-e.x, player.y-e.y) < 30 && !invincible) {
                    gameActive = false; endGame();
                }

                bullets.forEach((b, bi) => {
                    if(Math.hypot(b.x-e.x, b.y-e.y) < 30) {
                        bullets.splice(bi,1); e.hp--; e.flash=5;
                        spawnDmg(ex, ey, "-1");
                        if(e.hp<=0) {
                            enemies.splice(i,1); kills++;
                            document.getElementById('killsTxt').innerText=kills;
                            spawnDmg(ex, ey, "KILL!", "gold");
                        }
                    }
                });
            });

            // Particles (Damage Numbers)
            particles.forEach((p,i) => {
                p.y -= 1; p.life -= 0.02;
                if(p.life <= 0) particles.splice(i,1);
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color; ctx.font = "bold 20px Arial";
                ctx.fillText(p.text, p.x, p.y);
            });
            ctx.globalAlpha = 1.0;

            frame++; loopId = requestAnimationFrame(loop);
        }

        function spawnDmg(x, y, text, color="red") {
            // Coordenadas relativas a pantalla, ya que se dibujan en loop
            particles.push({x:x, y:y, text:text, life:1.0, color:color});
        }

        function endGame() {
            const reward = kills * 10;
            state.score += reward;
            document.getElementById('rewardTxt').innerText = `+${reward} $D`;
            document.getElementById('arenaOver').style.display = 'flex';
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            updateUI();
        }
    </script>
</body>
</html>
