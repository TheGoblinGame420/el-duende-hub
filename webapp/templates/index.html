<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Duende App</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        :root {
            --primary: #39ff14; --gold: #ffd700; --danger: #ff0055; --blue: #0098EA;
            --bg-dark: #1c1f24; --card: #272a2f; --nav: #16181b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: #000;
            background-image: radial-gradient(circle at 50% 0%, #2b3038 0%, #000 100%);
            color: #fff; font-family: 'Rajdhani', sans-serif;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none;
        }

        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 0.5s;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- HEADER --- */
        .header {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 10;
        }
        .balance-box { text-align: right; }
        .balance-label { font-size: 0.75rem; color: #888; letter-spacing: 1px; }
        .balance-val { font-size: 1.5rem; font-weight: 900; color: #fff; display: flex; align-items: center; gap: 5px; justify-content: flex-end; }
        .coin-icon { width: 24px; height: 24px; background: var(--gold); border-radius: 50%; display: inline-block; box-shadow: 0 0 10px var(--gold); }

        /* --- SCREENS --- */
        .screen { display: none; flex-grow: 1; flex-direction: column; align-items: center; width: 100%; overflow-y: auto; padding-bottom: 100px; }
        .screen.active { display: flex; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TAP ZONE --- */
        .tap-area {
            position: relative; margin-top: 40px; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center;
        }
        /* Glow Effect behind character */
        .glow-bg {
            position: absolute; width: 250px; height: 250px;
            background: radial-gradient(circle, rgba(57,255,20,0.2) 0%, transparent 70%);
            border-radius: 50%; z-index: 1; animation: pulseGlow 3s infinite;
        }
        @keyframes pulseGlow { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 0.8; } }

        .main-character {
            width: 260px; height: 260px; z-index: 2; object-fit: contain;
            cursor: pointer; transition: transform 0.05s;
            /* Truco para limpiar bordes blancos leves */
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); 
        }
        .main-character:active { transform: scale(0.95); }

        .energy-status {
            width: 90%; max-width: 350px; margin-top: 30px;
            background: var(--card); padding: 15px; border-radius: 15px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .energy-text { font-weight: bold; color: #aaa; font-size: 0.9rem; }
        .energy-num { font-weight: 900; color: #fff; font-size: 1.1rem; }
        .energy-bar { height: 8px; width: 100%; background: #111; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .energy-fill { height: 100%; width: 100%; background: linear-gradient(90deg, var(--gold), var(--primary)); transition: width 0.3s; }

        /* --- ARENA --- */
        #screen-arena { padding: 0; }
        .arena-container { width: 100%; height: 100%; position: relative; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        .arena-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20;
        }
        .arena-btn {
            background: linear-gradient(135deg, #ff3b3b, #990000);
            border: none; color: white; padding: 20px 50px; border-radius: 16px;
            font-size: 1.5rem; font-weight: 900; letter-spacing: 1px;
            box-shadow: 0 10px 25px rgba(255, 59, 59, 0.4);
            cursor: pointer; text-transform: uppercase;
        }

        /* --- SHOP & RANK --- */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 92%; margin-top: 20px; }
        .card {
            background: var(--card); border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            border: 1px solid rgba(255,255,255,0.05); transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); background: #333; }
        .card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; }
        .card h4 { margin: 0; font-size: 1rem; color: #fff; }
        .card p { margin: 5px 0 10px 0; font-size: 0.7rem; color: #888; }
        .btn-price {
            background: #333; color: #fff; padding: 8px 16px; border-radius: 8px;
            font-size: 0.85rem; font-weight: bold; width: 100%; border: none;
        }
        .btn-ton { background: var(--blue); }
        .btn-gold { background: var(--gold); color: #000; }

        /* --- NAV --- */
        .nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 85px;
            background: var(--nav); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 15px; z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: #555;
            font-size: 0.7rem; font-weight: bold; width: 25%; cursor: pointer;
        }
        .nav-item i { font-size: 1.6rem; margin-bottom: 5px; transition: 0.2s; }
        .nav-item.active { color: #fff; }
        .nav-item.active i { color: var(--primary); transform: translateY(-3px); text-shadow: 0 0 10px var(--primary); }

        /* --- FLOATING TEXT --- */
        .float-num { position: absolute; font-weight: 900; font-size: 2rem; color: var(--gold); pointer-events: none; animation: floatUp 0.8s forwards; z-index: 200; text-shadow: 0 2px 0 #000; }
        @keyframes floatUp { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold; letter-spacing:1px; color:#888;">INICIANDO...</p>
    </div>

    <div class="header">
        <div id="ton-connect"></div>
        <div class="balance-box">
            <div class="balance-label">PROFIT PER TAP</div>
            <div class="balance-val"><span class="coin-icon"></span> <span id="scoreDisplay">0</span></div>
        </div>
    </div>

    <div id="tab-tap" class="screen active">
        <div class="tap-area" id="tapZone">
            <div class="glow-bg"></div>
            <img id="charImg" src="" class="main-character">
        </div>

        <div class="energy-status">
            <div>
                <div class="energy-text">ENERG√çA</div>
                <div class="energy-num"><span id="energyVal">500</span> / 500</div>
            </div>
            <div style="text-align:right;">
                <div class="energy-text">BOOST</div>
                <div id="invincibleTag" style="color:var(--blue); font-weight:900; display:none;">ESCUDO</div>
            </div>
        </div>
        <div style="width:90%; margin-top:5px;"><div class="energy-bar"><div class="energy-fill" id="energyFill"></div></div></div>

        <div class="grid-container" style="margin-top:30px;">
            <div class="card" onclick="window.open('https://t.me/elduende420peru')">
                <i class="fab fa-telegram" style="font-size:2rem; color:#229ED9;"></i>
                <h4 style="margin-top:10px;">Telegram</h4>
            </div>
            <div class="card" onclick="window.open('https://wa.me/51900877863')">
                <i class="fab fa-whatsapp" style="font-size:2rem; color:#25D366;"></i>
                <h4 style="margin-top:10px;">WhatsApp</h4>
            </div>
        </div>
    </div>

    <div id="tab-arena" class="screen">
        <div class="arena-container">
            <canvas id="gameCanvas"></canvas>
            <div style="position:absolute; top:20px; left:20px; font-size:1.5rem; font-weight:900; z-index:10; pointer-events:none;">
                üíÄ <span id="killsTxt">0</span>
            </div>

            <div id="arenaStart" class="arena-overlay">
                <h1 style="font-size:3rem; color:var(--danger); margin:0; text-shadow:0 0 20px red;">SURVIVOR</h1>
                <p style="color:#aaa; margin-bottom:30px;">Sobrevive a la ca√≠da</p>
                <button class="arena-btn" onclick="startArena()">JUGAR</button>
                <p style="margin-top:10px; color:#666; font-size:0.8rem;">Costo: 50‚ö° o 150 monedas</p>
            </div>

            <div id="arenaEnd" class="arena-overlay" style="display:none;">
                <h1 style="color:var(--primary); font-size:2.5rem;">VICTORIA</h1>
                <p id="rewardTxt" style="font-size:1.5rem; font-weight:bold; margin-bottom:20px;">+0</p>
                <button class="arena-btn" style="background:#333; font-size:1rem;" onclick="closeArena()">SALIR</button>
            </div>
        </div>
    </div>

    <div id="tab-shop" class="screen">
        <h2 style="margin-top:20px; color:var(--gold);">MERCADO NEGRO</h2>
        
        <div style="width:92%; text-align:left; margin-top:10px; color:#666; font-size:0.8rem; font-weight:bold;">SKINS PREMIUM (TON)</div>
        <div class="grid-container">
            <div class="card">
                <img src="/static/skin_DUENDE_HACKER.png">
                <h4>HACKER</h4>
                <p>Velocidad x2</p>
                <button class="btn-price btn-ton" onclick="payTon('hacker', 0.2)">0.2 TON</button>
            </div>
            <div class="card">
                <img src="/static/skin_DUENDE_BOX.png">
                <h4>BOXER</h4>
                <p>Da√±o Cr√≠tico</p>
                <button class="btn-price btn-ton" onclick="payTon('boxer', 0.5)">0.5 TON</button>
            </div>
            <div class="card">
                <img src="/static/skin_REY_DUENDE.png">
                <h4>EL REY</h4>
                <p>Ganancia x2</p>
                <button class="btn-price btn-ton" onclick="payTon('king', 1.0)">1.0 TON</button>
            </div>
            <div class="card">
                <img src="/static/skin_DUENDE_MAESTRO.png">
                <h4>MAESTRO</h4>
                <p>Legendario</p>
                <button class="btn-price btn-ton" onclick="payTon('maestro', 2.0)">2.0 TON</button>
            </div>
        </div>

        <div style="width:92%; text-align:left; margin-top:20px; color:#666; font-size:0.8rem; font-weight:bold;">ITEMS (MONEDAS)</div>
        <div class="grid-container">
            <div class="card">
                <img src="/static/booster_RAYOTON.png">
                <h4>RECARGA</h4>
                <button class="btn-price btn-gold" onclick="buyItem('refill', 500)">500</button>
            </div>
            <div class="card">
                <img src="/static/booster_INVENCIBLE_90S.png">
                <h4>ESCUDO</h4>
                <button class="btn-price btn-gold" onclick="buyItem('shield', 2000)">2k</button>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="nav('tap', this)">
            <i class="fas fa-hammer"></i>
            <span>Minar</span>
        </div>
        <div class="nav-item" onclick="nav('arena', this)">
            <i class="fas fa-skull"></i>
            <span>Arena</span>
        </div>
        <div class="nav-item" onclick="nav('shop', this)">
            <i class="fas fa-shopping-cart"></i>
            <span>Tienda</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand(); tg.setHeaderColor('#1c1f24');
        const MY_WALLET = "UQAm2w4HcJ1tW8RBNj7BZQh0Q-ckpzlxzD-r8p2JduHkpQnc";

        // ASSETS CONFIG
        const assets = {
            common: '/static/skin_duende_comunparatodos.png',
            hacker: '/static/skin_DUENDE_HACKER.png',
            boxer: '/static/skin_DUENDE_BOX.png',
            king: '/static/skin_REY_DUENDE.png',
            maestro: '/static/skin_DUENDE_MAESTRO.png',
            bear: '/static/enemy_BEAR_MARKET.png',
            rug: '/static/enemy_RUG_PULL.png',
            whale: '/static/enemy_WHALE.png',
            bullet: '/static/loot_COIN.png'
        };
        const imgs = {};
        let loadedCount = 0;

        // SISTEMA DE CARGA ANTI-BLOQUEO
        function startLoading() {
            const total = Object.keys(assets).length;
            // Temporizador de seguridad: Si en 3 seg no carga, inicia igual
            setTimeout(() => {
                if(document.getElementById('loader').style.display !== 'none') {
                    console.warn("Forzando inicio por tiempo de espera...");
                    initApp();
                }
            }, 3000);

            Object.keys(assets).forEach(key => {
                imgs[key] = new Image();
                imgs[key].src = assets[key];
                imgs[key].onload = () => { loadedCount++; if(loadedCount===total) initApp(); };
                imgs[key].onerror = () => { console.log("Error cargando: " + key); loadedCount++; if(loadedCount===total) initApp(); };
            });
        }

        function initApp() {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            document.getElementById('charImg').src = imgs.common.src;
            updateUI();
        }

        // ESTADO
        let state = { score: 0, energy: 500, maxEnergy: 500, skin: 'common', power: 1 };
        let invincible = false;

        const tonUi = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: window.location.origin + '/static/tonconnect-manifest.json', buttonRootId: 'ton-connect', uiPreferences: {theme: TON_CONNECT_UI.THEME.DARK} });

        // --- CORE LOGIC ---
        function updateUI() {
            document.getElementById('scoreDisplay').innerText = Math.floor(state.score).toLocaleString();
            document.getElementById('energyVal').innerText = Math.floor(state.energy);
            document.getElementById('energyFill').style.width = (state.energy/state.maxEnergy*100) + '%';
        }

        function nav(tab, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(tab !== 'arena') stopArena();
        }

        // TAP
        document.getElementById('tapZone').addEventListener('click', (e) => {
            if(state.energy < 1) return;
            state.energy--; state.score += state.power; updateUI();
            
            // Animaci√≥n CSS
            const img = document.getElementById('charImg');
            img.style.transform = "scale(0.95) rotate(5deg)";
            setTimeout(() => img.style.transform = "scale(1) rotate(0deg)", 100);

            // Floating Text
            const float = document.createElement('div');
            float.className = 'float-num';
            float.innerText = "+" + state.power;
            float.style.left = e.clientX + 'px'; float.style.top = e.clientY + 'px';
            document.body.appendChild(float);
            setTimeout(()=>float.remove(), 800);

            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        });
        setInterval(() => { if(state.energy < state.maxEnergy) { state.energy++; updateUI(); } }, 1000);

        // TIENDA
        async function payTon(skin, price) {
            if(!tonUi.connected) return alert("Conecta Wallet");
            try {
                await tonUi.sendTransaction({validUntil: Math.floor(Date.now()/1000)+3600, messages:[{address:MY_WALLET, amount:Math.floor(price*1000000000).toString()}]});
                state.skin = skin; updateSkin(); alert("Comprado!");
            } catch(e) { alert("Cancelado"); }
        }
        function buyItem(type, cost) {
            if(state.score < cost) return alert("Falta Saldo");
            state.score -= cost;
            if(type==='refill') state.energy = state.maxEnergy;
            if(type==='shield') { invincible=true; document.getElementById('invincibleTag').style.display='block'; setTimeout(()=>{invincible=false;document.getElementById('invincibleTag').style.display='none';}, 90000); }
            updateUI();
        }
        function updateSkin() {
            let src = imgs.common.src; state.power=1;
            if(state.skin==='hacker') { src=imgs.hacker.src; state.power=2; }
            if(state.skin==='boxer') { src=imgs.boxer.src; state.power=3; }
            if(state.skin==='king') { src=imgs.king.src; state.power=2; } // Multiplicador en Arena
            if(state.skin==='maestro') { src=imgs.maestro.src; state.power=5; }
            document.getElementById('charImg').src = src;
        }

        // --- ARENA ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameActive = false, loopId;
        let player={x:0,y:0}, enemies=[], bullets=[], particles=[], kills=0;
        let stick={active:false, sx:0, sy:0, nx:0, ny:0};
        let frame=0;

        function startArena() {
            if(state.energy >= 50) state.energy-=50;
            else if(state.score >= 150) state.score-=150;
            else return alert("Falta 50‚ö° o 150 monedas");
            
            updateUI();
            document.getElementById('arenaStart').style.display='none';
            document.getElementById('arenaEnd').style.display='none';
            resize(); player={x:0, y:0}; enemies=[]; bullets=[]; kills=0;
            gameActive=true; loop();
        }
        
        function stopArena() { gameActive=false; cancelAnimationFrame(loopId); }
        function closeArena() { document.getElementById('arenaStart').style.display='flex'; document.getElementById('arenaEnd').style.display='none'; }
        
        function resize() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.parentElement.clientWidth * dpr;
            canvas.height = canvas.parentElement.clientHeight * dpr;
            ctx.scale(dpr, dpr);
        }

        // Joystick Logic
        canvas.addEventListener('touchstart', e=>{ stick.active=true; stick.sx=e.touches[0].clientX; stick.sy=e.touches[0].clientY; stick.nx=stick.sx; stick.ny=stick.sy; });
        canvas.addEventListener('touchmove', e=>{ if(stick.active){ e.preventDefault(); stick.nx=e.touches[0].clientX; stick.ny=e.touches[0].clientY; } });
        canvas.addEventListener('touchend', ()=>{ stick.active=false; });

        function loop() {
            if(!gameActive) return;
            const W = canvas.width/window.devicePixelRatio; const H = canvas.height/window.devicePixelRatio;
            
            // Player Move
            if(stick.active) {
                const dx = stick.nx-stick.sx; const dy = stick.ny-stick.sy;
                const dist = Math.hypot(dx,dy);
                if(dist>10) {
                    const ang = Math.atan2(dy,dx);
                    player.x += Math.cos(ang)*5; player.y += Math.sin(ang)*5;
                }
            }

            // Camera
            const camX = player.x - W/2; const camY = player.y - H/2;

            // Render
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H);
            ctx.strokeStyle = '#222'; ctx.lineWidth=2;
            const grid=80;
            const ox=Math.floor(camX/grid)*grid; const oy=Math.floor(camY/grid)*grid;
            for(let x=ox; x<camX+W+grid; x+=grid) for(let y=oy; y<camY+H+grid; y+=grid) ctx.strokeRect(x-camX, y-camY, grid, grid);

            // Draw Player
            const pImg = state.skin==='common' ? imgs.common : imgs[state.skin];
            const px = W/2; const py = H/2;
            if(invincible) { ctx.beginPath(); ctx.arc(px,py,40,0,7); ctx.strokeStyle='#0ff'; ctx.stroke(); }
            ctx.drawImage(pImg, px-30, py-30, 60, 60);

            // Logic Enemies
            if(frame%50===0) {
                const ang = Math.random()*6.28; const dist = W/2+100;
                let type='bear', hp=3, spd=2;
                if(Math.random()>0.8) { type='rug'; spd=4; hp=2; }
                if(Math.random()>0.95) { type='whale'; spd=1; hp=15; }
                enemies.push({x:player.x+Math.cos(ang)*dist, y:player.y+Math.sin(ang)*dist, type:type, hp:hp, spd:spd});
            }

            // Auto Shoot
            if(frame%20===0 && enemies.length>0) {
                const target = enemies.reduce((a,b)=>Math.hypot(a.x-player.x, a.y-player.y)<Math.hypot(b.x-player.x, b.y-player.y)?a:b);
                const ang = Math.atan2(target.y-player.y, target.x-player.x);
                bullets.push({x:player.x, y:player.y, vx:Math.cos(ang)*12, vy:Math.sin(ang)*12, life:60});
            }

            // Update Entities
            bullets.forEach((b,i) => {
                b.x+=b.vx; b.y+=b.vy; b.life--;
                ctx.drawImage(imgs.bullet, b.x-camX-10, b.y-camY-10, 20, 20);
                if(b.life<=0) bullets.splice(i,1);
            });

            enemies.forEach((e,i) => {
                const ang = Math.atan2(player.y-e.y, player.x-e.x);
                e.x += Math.cos(ang)*e.spd; e.y += Math.sin(ang)*e.spd;
                ctx.drawImage(imgs[e.type], e.x-camX-25, e.y-camY-25, 50, 50);

                if(Math.hypot(player.x-e.x, player.y-e.y)<30 && !invincible) { gameActive=false; endGame(); }

                bullets.forEach((b,bi) => {
                    if(Math.hypot(b.x-e.x, b.y-e.y)<30) {
                        bullets.splice(bi,1); e.hp--;
                        if(e.hp<=0) { enemies.splice(i,1); kills++; document.getElementById('killsTxt').innerText=kills; }
                    }
                });
            });

            frame++; loopId = requestAnimationFrame(loop);
        }

        function endGame() {
            const reward = kills*10; state.score+=reward;
            document.getElementById('rewardTxt').innerText = `+${reward}`;
            document.getElementById('arenaEnd').style.display='flex';
            updateUI();
        }

        // INICIAR
        startLoading();
    </script>
</body>
</html>
